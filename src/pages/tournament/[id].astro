---
import Layout from '@/layouts/Layout.astro';
import { createClientServer } from '@/lib/supabaseClient';
import ResultsTable from '@/components/tournament/ResultsTable';

const { id } = Astro.params;
const supabase = createClientServer(Astro.cookies);

const { data: tournament } = await supabase
  .from('tournaments')
  .select('*')
  .eq('id', id!)
  .maybeSingle();

// Get results from event_results table
const { data: results } = await supabase
  .from('event_results')
  .select('*, teams!inner(id, name, logo_url)')
  .eq('tournament_id', id!)
  .order('placement', { ascending: true })
  .limit(20);

// Format for display
const formattedResults = results?.map((r: any) => {
  const team = Array.isArray(r.teams) ? r.teams[0] : r.teams;
  return {
    team_id: team?.id || r.team_id,
    team_name: team?.name || 'Unknown Team',
    logo_url: team?.logo_url,
    final_placement: r.placement,
    wins: 0, // Not tracked in event_results
    losses: 0
  };
}) || [];
---

<Layout title={`${tournament?.name || 'Tournament'} - Global Rankings`}>
  <div class="app-theme">
    <div class="container">
      {tournament ? (
        <>
          <div class="paper" style="margin-bottom: 2rem;">
            <div style="display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;">
              {tournament.organizer_logo_url && (
                <img 
                  src={tournament.organizer_logo_url} 
                  alt={tournament.organizer_name || 'Organizer'} 
                  style="width: 80px; height: 80px; object-fit: contain;"
                />
              )}
              <div style="flex: 1;">
                <h1 style="margin: 0 0 0.5rem; font-size: 2.5rem;">{tournament.name}</h1>
                <p class="text-secondary">
                  Organizer
                  {tournament.start_date && ` â€¢ ${new Date(tournament.start_date).toLocaleDateString()}`}
                </p>
              </div>
              {tournament.tier && (
                <span style="padding: 0.5rem 1rem; border-radius: 4px; background: var(--color-primary); color: white; font-weight: 600;">
                  {tournament.tier}
                </span>
              )}
            </div>
          </div>

          <div class="paper">
            <h2 style="margin-bottom: 1.5rem;">Results - Click team to view profile</h2>
            {formattedResults && formattedResults.length > 0 ? (
              <ResultsTable results={formattedResults} client:load />
            ) : (
              <p class="text-secondary">No results found</p>
            )}
          </div>
        </>
      ) : (
        <div class="paper">
          <p class="text-secondary">Tournament not found</p>
        </div>
      )}
    </div>
  </div>
</Layout>
