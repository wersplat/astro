---
import Layout from '@/layouts/Layout.astro';
import { createClientServer } from '@/lib/supabaseClient';

const { id } = Astro.params;
const supabase = createClientServer(Astro.cookies);

const { data: crew } = await supabase
  .from('city_crews')
  .select('*')
  .eq('id', id!)
  .maybeSingle();

const { data: members } = await supabase
  .from('players')
  .select('id, gamertag, position, player_rp, performance_score')
  .eq('crew_affiliation', id!);
---

<Layout title={`${crew?.crewName || 'Crew'} - Global Rankings`}>
  <div class="app-theme">
    <div class="container">
      {crew ? (
        <>
          <div class="paper" style="margin-bottom: 2rem;">
            <div style="display: flex; align-items: center; gap: 1.5rem;">
              {crew.crew_logo && (
                <img 
                  src={crew.crew_logo} 
                  alt={crew.crewName || 'Crew'} 
                  style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;"
                />
              )}
              <div>
                <h1 style="margin: 0 0 0.5rem; font-size: 2rem;">{crew.crewName}</h1>
                <p class="text-secondary">{crew.crewRegion || 'Region Unknown'}</p>
                {crew.crewRank && (
                  <p style="color: var(--color-primary); font-weight: 600;">
                    Rank #{crew.crewRank}
                  </p>
                )}
              </div>
            </div>
          </div>

          <div class="paper">
            <h2 style="margin-bottom: 1.5rem;">Members ({members?.length || 0})</h2>
            <div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">
              {members?.map((member) => (
                <a href={`/player/${member.id}`} class="card" style="text-decoration: none; color: inherit;">
                  <h4 style="margin: 0 0 0.5rem;">{member.gamertag}</h4>
                  <p class="text-secondary" style="font-size: 0.875rem; margin: 0;">
                    {member.position || 'Position Unknown'}
                  </p>
                  {member.player_rp && (
                    <p style="margin: 0.5rem 0 0; font-weight: 600; color: var(--color-primary);">
                      {member.player_rp} RP
                    </p>
                  )}
                </a>
              ))}
            </div>
            {(!members || members.length === 0) && (
              <p class="text-secondary">No members found</p>
            )}
          </div>
        </>
      ) : (
        <div class="paper">
          <p class="text-secondary">Crew not found</p>
        </div>
      )}
    </div>
  </div>
</Layout>
